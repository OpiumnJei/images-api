# ===========================================
# CONFIGURACION DE RESILIENCE4J
# Patrones de tolerancia a fallos
# ===========================================

# cada instance es un conjunto de reglas a medida para un problema especifico.
resilience4j:
  # ============================================
  # CIRCUIT BREAKER - Prevencion de fallos en cascada
  # ============================================
  circuitbreaker:
    configs:
      default:
        # Registra el estado del circuit breaker en el health endpoint
        registerHealthIndicator: true
        # Tamano de la ventana deslizante (ultimas 10 llamadas)
        slidingWindowSize: 10
        # Tipo de ventana: COUNT_BASED (por llamadas) o TIME_BASED (por tiempo)
        slidingWindowType: COUNT_BASED
        # Numero minimo de llamadas antes de calcular el porcentaje de fallos
        minimumNumberOfCalls: 5
        # Porcentaje de fallos para abrir el circuito (50% = 5 de 10 fallan)
        failureRateThreshold: 50
        # Tiempo que el circuito permanece OPEN antes de pasar a HALF-OPEN
        waitDurationInOpenState: 30s
        # Llamadas permitidas en estado HALF-OPEN para probar si el servicio se recupero
        permittedNumberOfCallsInHalfOpenState: 3
        # Transicion automatica de OPEN a HALF-OPEN sin esperar una llamada
        automaticTransitionFromOpenToHalfOpenEnabled: true
        # Excepciones que cuentan como fallo
        recordExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.web.client.ResourceAccessException
          - org.springframework.dao.DataAccessResourceFailureException
        # Excepciones que se ignoran (no cuentan como fallo ni exito)
        ignoreExceptions:
          - com.greetingsapp.imagesapi.infra.errors.ResourceNotFoundException
          - com.greetingsapp.imagesapi.infra.errors.DuplicateResourceException

    # Configuraciones especificas por instancia
    instances:
      # Circuit breaker para operaciones de base de datos
      databaseCB:
        baseConfig: default
        failureRateThreshold: 60 # Mas tolerante a fallos de BD 60%
        slidingWindowSize: 10     # Evalua las ultimas 10 llamadas
        waitDurationInOpenState: 20s # Espera 20s antes de probar de nuevo

      # Circuit breaker para servicios externos (futuras integraciones)
      externalServiceCB:
        baseConfig: default
        failureRateThreshold: 50
        waitDurationInOpenState: 60s
        slowCallDurationThreshold: 2s
        slowCallRateThreshold: 80



  # ============================================
  # RETRY - Reintentos para fallos transitorios
  # ============================================
  retry:
    configs:
      default:
        # Numero maximo de intentos (incluyendo el primero)
        maxAttempts: 3
        # Tiempo de espera entre reintentos
        waitDuration: 500ms
        # Habilitar backoff exponencial (espera crece: 500ms, 1s, 2s...)
        enableExponentialBackoff: true
        # Multiplicador del backoff exponencial
        exponentialBackoffMultiplier: 2
        # Excepciones que disparan reintento
        retryExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.dao.QueryTimeoutException
          - org.springframework.dao.DataAccessResourceFailureException
        # Excepciones que NO disparan reintento
        ignoreExceptions:
          - com.greetingsapp.imagesapi.infra.errors.ResourceNotFoundException
          - com.greetingsapp.imagesapi.infra.errors.DuplicateResourceException
          - jakarta.validation.ValidationException

    instances:
      databaseRetry:
        baseConfig: default
        maxAttempts: 3 # Total de 3 intentos
        waitDuration: 300ms # Espera inicial
        enableExponentialBackoff: true # 300ms -> 600ms -> 1200ms

      externalServiceRetry:
        baseConfig: default
        maxAttempts: 4
        waitDuration: 1s



  # ============================================
  # RATE LIMITER - Proteccion contra sobrecarga
  # ============================================
  ratelimiter:
    configs:
      default:
        # Registrar en health indicator
        registerHealthIndicator: true
        # Numero de permisos disponibles en el periodo
        limitForPeriod: 100
        # Duracion del periodo de renovacion
        limitRefreshPeriod: 1s
        # Tiempo maximo de espera para obtener un permiso
        timeoutDuration: 0s

    instances:
      # Rate limiter estricto para endpoints publicos de lectura
      publicApiRL:
        baseConfig: default
        limitForPeriod: 50 # Maximo 50 solicitudes por segundo
        limitRefreshPeriod: 1s
        timeoutDuration: 500ms

      # Rate limiter mas permisivo para endpoints de admin
      adminApiRL:
        baseConfig: default
        limitForPeriod: 100 # Maximo 100 solicitudes por segundo
        limitRefreshPeriod: 1s

      # Rate limiter muy estricto para autenticacion (prevenir brute force)
      authRL:
        limitForPeriod: 10 # Maximo 10 solicitudes por segundo
        limitRefreshPeriod: 1s
        timeoutDuration: 0s



# ============================================
# ACTUATOR - Endpoints de monitoreo
# ============================================

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,circuitbreakers,ratelimiters,retries
  endpoint:
    health:
      show-details: always
  health:
    circuitbreakers:
      enabled: true
    ratelimiters:
      enabled: true
